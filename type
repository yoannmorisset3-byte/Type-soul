local Players = game:GetService("Players")
local player = Players.LocalPlayer

local autofarmEnabled = false
local guiOpen = true

-- GUI principale
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TypeSoulGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Fenêtre principale
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 732, 0, 732)
frame.Position = UDim2.new(0, 20, 0.7, -732)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.BackgroundTransparency = 0.1
frame.Parent = screenGui

-- Bouton de fermeture (X)
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 40, 0, 30)
closeBtn.Position = UDim2.new(1, -90, 0, 10)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 22
closeBtn.Parent = frame

-- Bouton de réduction (-)
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 40, 0, 30)
minimizeBtn.Position = UDim2.new(1, -45, 0, 10)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
minimizeBtn.Text = "-"
minimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeBtn.Font = Enum.Font.SourceSansBold
minimizeBtn.TextSize = 22
minimizeBtn.Parent = frame

-- Titre
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 0, 50)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "Type Soul Utility"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 36
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

-- Icône réduite
local minimizedBtn = Instance.new("ImageButton")
minimizedBtn.Size = UDim2.new(0, 60, 0, 60)
minimizedBtn.Position = UDim2.new(0, 20, 0.7, 0)
minimizedBtn.BackgroundTransparency = 1
minimizedBtn.Image = "rbxassetid://0" -- Remplace par ton AssetId Roblox
minimizedBtn.Visible = false
minimizedBtn.Parent = screenGui

-- Ouvrir depuis icône réduite
minimizedBtn.MouseButton1Click:Connect(function()
    frame.Visible = true
    minimizedBtn.Visible = false
end)

-- Réduire
minimizeBtn.MouseButton1Click:Connect(function()
    frame.Visible = false
    minimizedBtn.Visible = true
end)

-- Fermer
closeBtn.MouseButton1Click:Connect(function()
    frame.Visible = false
    minimizedBtn.Visible = true
end)

-- === Onglets ===
local tabButtons = {}
local currentTab = nil
local tabContent = {}

local function createTab(name, index)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(0, 120, 0, 40)
    btn.Position = UDim2.new(0, 10 + (index - 1) * 130, 0, 70)
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 22
    btn.Text = name
    btn.Parent = frame

    local contentFrame = Instance.new("Frame", frame)
    contentFrame.Size = UDim2.new(1, -20, 1, -130)
    contentFrame.Position = UDim2.new(0, 10, 0, 120)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Visible = false
    contentFrame.Parent = frame

    btn.MouseButton1Click:Connect(function()
        if currentTab then
            tabContent[currentTab].Visible = false
        end
        currentTab = name
        tabContent[currentTab].Visible = true
    end)

    tabButtons[name] = btn
    tabContent[name] = contentFrame
end

-- Onglets : AutoFarm & ESP
createTab("AutoFarm", 1)
createTab("ESP", 2)

-- Contenu AutoFarm
local autoFarmFrame = tabContent["AutoFarm"]

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 40)
statusLabel.Position = UDim2.new(0, 10, 0, 10)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Status: OFF"
statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 28
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = autoFarmFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0.6, 0, 0, 60)
toggleBtn.Position = UDim2.new(0.2, 0, 0, 60)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
toggleBtn.Text = "Activer AutoFarm"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextSize = 28
toggleBtn.Parent = autoFarmFrame

-- (Tu peux rajouter plus d'options ici)

-- Contenu ESP
local espFrame = tabContent["ESP"]

local espLabel = Instance.new("TextLabel")
espLabel.Size = UDim2.new(1, -20, 0, 40)
espLabel.Position = UDim2.new(0, 10, 0, 10)
espLabel.BackgroundTransparency = 1
espLabel.Text = "ESP options ici (à compléter)"
espLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
espLabel.Font = Enum.Font.SourceSans
espLabel.TextSize = 28
espLabel.TextXAlignment = Enum.TextXAlignment.Left
espLabel.Parent = espFrame

-- === AutoFarm logique ===
local NORMAL_RANGE = 30
local RANGE = NORMAL_RANGE * 3

local function getNearestEnemy()
    local nearestEnemy = nil
    local nearestDistance = math.huge
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return nil end
    for _, npc in pairs(workspace:FindFirstChild("Enemies") and workspace.Enemies:GetChildren() or {}) do
        if npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 and npc:FindFirstChild("HumanoidRootPart") then
            local dist = (npc.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
            if dist < nearestDistance and dist <= RANGE then
                nearestDistance = dist
                nearestEnemy = npc
            end
        end
    end
    return nearestEnemy
end

local autofarmThread

local function startAutoFarm()
    if autofarmThread then return end
    autofarmThread = task.spawn(function()
        while autofarmEnabled do
            local enemy = getNearestEnemy()
            if enemy and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 2)
                local tool = player.Character:FindFirstChildOfClass("Tool")
                if tool and tool:FindFirstChild("Handle") then
                    tool:Activate()
                end
            end
            task.wait(0.5)
        end
        autofarmThread = nil
    end)
end

local function stopAutoFarm()
    autofarmEnabled = false
end

toggleBtn.MouseButton1Click:Connect(function()
    autofarmEnabled = not autofarmEnabled
    if autofarmEnabled then
        statusLabel.Text = "Status: ON"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        toggleBtn.Text = "Désactiver AutoFarm"
        startAutoFarm()
    else
        statusLabel.Text = "Status: OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        toggleBtn.Text = "Activer AutoFarm"
        stopAutoFarm()
    end
end)
