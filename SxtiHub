-- GUI complet Type Soul avec auto quÃªte tableau + amÃ©liorations + God Mode

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- Variables
local questBoardName = "QuestBoard" -- Change selon le nom exact du tableau dans workspace
local KilledTargets = {}

-- ðŸ–¼ï¸ GUI Setup
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "TypeSoulAutofarmGUI"

local Background = Instance.new("ImageLabel", ScreenGui)
Background.Size = UDim2.new(0, 300, 0, 400)
Background.Position = UDim2.new(0, 10, 0.5, -200) -- Ã  gauche 10 px du bord
Background.Image = "rbxassetid://17164673956"
Background.BackgroundTransparency = 1
Background.ScaleType = Enum.ScaleType.Crop
Background.ClipsDescendants = true

-- ðŸ’¡ Bouton crÃ©ation helper
local buttons = {}

local function createButton(name, posY, callback)
    local btn = Instance.new("TextButton", Background)
    btn.Size = UDim2.new(0.8, 0, 0, 30)
    btn.Position = UDim2.new(0.1, 0, 0, posY)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.GothamBold
    btn.TextScaled = true
    btn.MouseButton1Click:Connect(callback)
    buttons[name] = btn
    return btn
end

-- Fonction tÃ©lÃ©port devant le tableau de quÃªte
local function teleportToQuestBoard()
    local questBoard = workspace:FindFirstChild(questBoardName)
    if questBoard and questBoard.PrimaryPart then
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            root.CFrame = questBoard.PrimaryPart.CFrame * CFrame.new(0, 0, 3)
            task.wait(0.5)
        end
    else
        warn("Tableau de quÃªte introuvable ou sans PrimaryPart")
    end
end

-- Fonction prendre quÃªte sur le tableau
local function takeQuest()
    local questBoard = workspace:FindFirstChild(questBoardName)
    if not questBoard then
        warn("Tableau de quÃªte introuvable : " .. questBoardName)
        return false
    end
    teleportToQuestBoard()
    for _, child in pairs(questBoard:GetChildren()) do
        if child:IsA("ClickDetector") then
            fireclickdetector(child)
            task.wait(0.5)
            return true
        end
    end
    local prompt = questBoard:FindFirstChildOfClass("ProximityPrompt")
    if prompt and prompt.Enabled then
        fireproximityprompt(prompt)
        task.wait(0.5)
        return true
    end
    warn("Aucun ClickDetector ou ProximityPrompt trouvÃ© sur le tableau")
    return false
end

-- Chercher tous les ennemis "Enemy" vivants dans workspace
local function getAliveEnemies()
    local enemies = {}
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return enemies end
    for _, npc in ipairs(workspace:GetDescendants()) do
        if npc:IsA("Model") and npc:FindFirstChild("Humanoid") and npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Enemy") then
            if npc.Humanoid.Health > 0 then
                table.insert(enemies, npc)
            end
        end
    end
    return enemies
end

-- Regroupe ennemis proche de toi (dans un rayon)
local function regroupEnemies(enemies)
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    for _, enemy in ipairs(enemies) do
        if enemy and enemy:FindFirstChild("HumanoidRootPart") then
            enemy.HumanoidRootPart.CFrame = root.CFrame + Vector3.new(math.random(-3,3), 0, math.random(-3,3))
        end
    end
end

-- Attaque les ennemis en spam clic souris
local function attackEnemies()
    for _, enemy in ipairs(getAliveEnemies()) do
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root and enemy:FindFirstChild("HumanoidRootPart") then
            root.CFrame = enemy.HumanoidRootPart.CFrame + Vector3.new(0,8,0)
            task.wait(0.1)
            for _=1,2 do
                VirtualInputManager:SendMouseButtonEvent(500, 500, 0, true, game, 1)
                task.wait(0.05)
                VirtualInputManager:SendMouseButtonEvent(500, 500, 0, false, game, 1)
            end
        end
    end
end

-- Auto execute avec la touche B si tous ennemis de la quÃªte sont morts
local function autoExecuteIfAllDead()
    local enemies = getAliveEnemies()
    if #enemies == 0 then
        -- Tous morts, appuie sur B
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
    end
end

-- ðŸ” AutoFarm + quÃªte + regroupement + attaque + auto execute
getgenv().AutoFarm = false
createButton("â–¶ AutoFarm", 10, function()
    getgenv().AutoFarm = not getgenv().AutoFarm
    if getgenv().AutoFarm then
        while getgenv().AutoFarm do
            task.wait(0.5)
            pcall(function()
                if not LocalPlayer.Character then return end
                local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if not root then return end

                takeQuest()
                local enemies = getAliveEnemies()
                if #enemies > 0 then
                    regroupEnemies(enemies)
                    attackEnemies()
                    autoExecuteIfAllDead()
                else
                    -- Pas d'ennemis, attend
                    task.wait(1)
                end
            end)
        end
    end
end)

-- ðŸ’€ Auto Execute KO (uniquement sur mobs tuÃ©s)
getgenv().AutoExecute = false
createButton("ðŸ’€ AutoExecute", 50, function()
    getgenv().AutoExecute = not getgenv().AutoExecute
    if getgenv().AutoExecute then
        while getgenv().AutoExecute do
            task.wait(0.2)
            for target, _ in pairs(KilledTargets) do
                if target and target.Parent and target:FindFirstChild("Humanoid") then
                    if target.Humanoid.Health <= 10 then
                        pcall(function()
                            LocalPlayer.Character:PivotTo(target:GetPivot())
                            task.wait(0.1)
                            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
                            task.wait(0.05)
                            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
                        end)
                    end
                else
                    KilledTargets[target] = nil
                end
            end
        end
    end
end)

-- God Mode
getgenv().GodMode = false
createButton("ðŸ›¡ï¸ God Mode", 90, function()
    getgenv().GodMode = not getgenv().GodMode
    local btn = buttons["ðŸ›¡ï¸ God Mode"]
    btn.Text = getgenv().GodMode and "ðŸ›¡ï¸ God Mode ON" or "ðŸ›¡ï¸ God Mode"
    if getgenv().GodMode then
        spawn(function()
            while getgenv().GodMode do
                task.wait(0.1)
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChildOfClass("Humanoid")
                    if humanoid and humanoid.Health < humanoid.MaxHealth then
                        humanoid.Health = humanoid.MaxHealth
                    end
                end
            end
        end)
    end
end)

-- âœˆï¸ Fly via loadstring fourni
getgenv().Fly = false
local flyButton = createButton("â˜ Safe Fly", 130, function()
    getgenv().Fly = not getgenv().Fly
    if getgenv().Fly then
        flyButton.Text = "Sxti"
        print("Flying Enabled")
        loadstring("\108\111\97\100\115\116\114\105\110\103\40\103\97\109\101\58\72\116\116\112\71\101\116\40\40\39\104\116\116\112\115\58\47\47\103\105\115\116\46\103\105\116\104\117\98\117\115\101\114\99\111\110\116\101\110\116\46\99\111\109\47\109\101\111\122\111\110\101\89\84\47\98\102\48\51\55\100\102\102\57\102\48\97\55\48\48\49\55\51\48\52\100\100\100\54\55\102\100\99\100\51\55\48\47\114\97\119\47\101\49\52\101\55\52\102\52\50\53\98\48\54\48\100\102\53\50\51\51\52\51\99\102\51\48\98\55\56\55\48\55\52\101\98\51\99\53\100\50\47\97\114\99\101\117\115\37\50\53\50\48\120\37\50\53\50\48\102\108\121\37\50\53\50\48\50\37\50\53\50\48\111\98\102\108\117\99\97\116\111\114\39\41\44\116\114\117\101\41\41\40\41\10\n")()
    else
        flyButton.Text = "â˜ Safe Fly"
        print("Flying Disabled")
    end
end)

-- ðŸ§  ESP Joueurs
createButton("ðŸ§º ESP Joueurs", 170, function()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and not player.Character:FindFirstChild("ESP") then
            local head = player.Character:FindFirstChild("Head")
            if head then
                local billboard = Instance.new("BillboardGui", player.Character)
                billboard.Name = "ESP"
                billboard.Size = UDim2.new(0, 100, 0, 20)
                billboard.Adornee = head
                billboard.AlwaysOnTop = true
                local label = Instance.new("TextLabel", billboard)
                label.Size = UDim2.new(1, 0, 1, 0)
                label.Text = player.Name
                label.BackgroundTransparency = 1
                label.TextColor3 = Color3.new(1, 0, 0)
                label.TextScaled = true
            end
        end
    end
end)

-- âŒ Stop All
createButton("âŒ Stop All", 210, function()
    getgenv().AutoFarm = false
    getgenv().AutoExecute = false
    getgenv().Fly = false
    getgenv().GodMode = false
    flyButton.Text = "â˜ Safe Fly"
    buttons["ðŸ›¡ï¸ God Mode"].Text = "ðŸ›¡ï¸ God Mode"
end)
