-- GUI complet Type Soul avec auto qu√™te tableau + am√©liorations

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- Variables
local questBoardName = "QuestBoard" -- Change selon le nom exact du tableau dans workspace
local KilledTargets = {}

-- üñºÔ∏è GUI Setup
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "TypeSoulAutofarmGUI"

local Background = Instance.new("ImageLabel", ScreenGui)
Background.Size = UDim2.new(0, 300, 0, 400)
Background.Position = UDim2.new(0, 10, 0.5, -200) -- √† gauche 10 px du bord
Background.Image = "rbxassetid://17164673956"
Background.BackgroundTransparency = 1
Background.ScaleType = Enum.ScaleType.Crop
Background.ClipsDescendants = true

-- üí° Bouton cr√©ation helper
local buttons = {}

local function createButton(name, posY, callback)
    local btn = Instance.new("TextButton", Background)
    btn.Size = UDim2.new(0.8, 0, 0, 30)
    btn.Position = UDim2.new(0.1, 0, 0, posY)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.GothamBold
    btn.TextScaled = true
    btn.MouseButton1Click:Connect(callback)
    buttons[name] = btn
    return btn
end

-- Fonction pour v√©rifier si une qu√™te est active (√† adapter selon jeu)
local function isQuestActive()
    local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
    if leaderstats and leaderstats:FindFirstChild("Quest") then
        local questName = leaderstats.Quest.Value
        return questName ~= "" and questName ~= "None"
    end
    return false
end

-- Fonction pour r√©cup√©rer les ennemis de la qu√™te actuelle
local function findQuestEnemies()
    local character = LocalPlayer.Character
    if not character then return {} end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return {} end

    local enemies = {}
    for _, npc in ipairs(workspace:GetDescendants()) do
        if npc:IsA("Model") and npc:FindFirstChild("Humanoid") and npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Enemy") then
            if npc.Humanoid.Health > 0 then
                table.insert(enemies, npc)
            end
        end
    end
    return enemies
end

-- Calcule le centre moyen d'une liste de mod√®les
local function getCenterPosition(models)
    if #models == 0 then return nil end
    local sum = Vector3.new()
    for _, m in ipairs(models) do
        if m and m:FindFirstChild("HumanoidRootPart") then
            sum = sum + m.HumanoidRootPart.Position
        end
    end
    return sum / #models
end

-- Fonction prendre qu√™te sur le tableau (avec TP devant)
local function takeQuest()
    local questBoard = workspace:FindFirstChild(questBoardName)
    if not questBoard or not questBoard.PrimaryPart then
        warn("Tableau de qu√™te introuvable ou sans PrimaryPart : " .. questBoardName)
        return false
    end

    local character = LocalPlayer.Character
    if not character then return false end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return false end

    -- T√©l√©porte pr√©cis√©ment devant le tableau (ajuste la distance selon besoin)
    local frontCFrame = questBoard.PrimaryPart.CFrame * CFrame.new(0, 0, 3)
    root.CFrame = frontCFrame
    task.wait(0.5)

    -- Essaye d'activer la qu√™te via ClickDetector
    for _, child in pairs(questBoard:GetChildren()) do
        if child:IsA("ClickDetector") then
            fireclickdetector(child)
            task.wait(1)
            return true
        end
    end

    -- Sinon, essai via ProximityPrompt
    local prompt = questBoard:FindFirstChildOfClass("ProximityPrompt")
    if prompt and prompt.Enabled then
        fireproximityprompt(prompt)
        task.wait(1)
        return true
    end

    warn("Aucun ClickDetector ou ProximityPrompt trouv√© sur le tableau")
    return false
end

-- Fonction envoyer touche B (Auto Execute)
local function autoExecute()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.B, false, game)
    task.wait(0.1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.B, false, game)
    print("Auto Execute activ√© (touche B simul√©e)")
end

-- AutoFarm + Auto Execute
getgenv().AutoFarm = false
createButton("‚ñ∂ AutoFarm", 10, function()
    getgenv().AutoFarm = not getgenv().AutoFarm
    if getgenv().AutoFarm then
        while getgenv().AutoFarm do
            task.wait(0.5)
            pcall(function()
                local character = LocalPlayer.Character
                if not character then return end
                local root = character:FindFirstChild("HumanoidRootPart")
                if not root then return end

                -- Prendre la qu√™te si pas active
                if not isQuestActive() then
                    local success = takeQuest()
                    if not success then
                        warn("Echec prise de qu√™te")
                        task.wait(2)
                        return
                    end
                    task.wait(2) -- temps pour valider la qu√™te
                end

                -- Chercher ennemis actifs de la qu√™te
                local enemies = findQuestEnemies()

                if #enemies == 0 then
                    -- Tous ennemis morts => auto execute
                    autoExecute()
                    task.wait(3) -- attendre un peu pour la prochaine qu√™te
                    return
                end

                -- Regroupement au centre des ennemis
                local centerPos = getCenterPosition(enemies)
                if centerPos then
                    root.CFrame = CFrame.new(centerPos + Vector3.new(0, 8, 0))
                    task.wait(0.3)
                end

                -- Attaque les ennemis
                for _, enemy in ipairs(enemies) do
                    if enemy and enemy.Parent and enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 then
                        local dist = (enemy.HumanoidRootPart.Position - root.Position).Magnitude
                        if dist > 15 then
                            root.CFrame = enemy.HumanoidRootPart.CFrame + Vector3.new(0, 8, 0)
                            task.wait(0.2)
                        end

                        for i=1, 3 do
                            VirtualInputManager:SendMouseButtonEvent(500, 500, 0, true, game, 1)
                            task.wait(0.05)
                            VirtualInputManager:SendMouseButtonEvent(500, 500, 0, false, game, 1)
                            task.wait(0.1)
                        end
                    end
                end
            end)
        end
    end
end)

-- üíÄ Auto Execute KO (optionnel, tu peux supprimer si tu veux)
getgenv().AutoExecute = false
createButton("üíÄ AutoExecute", 50, function()
    getgenv().AutoExecute = not getgenv().AutoExecute
    if getgenv().AutoExecute then
        while getgenv().AutoExecute do
            task.wait(0.2)
            -- Ne fait rien ici car on g√®re auto execute dans AutoFarm
        end
    end
end)

-- ‚úàÔ∏è Fly via loadstring fourni
getgenv().Fly = false
local flyButton = createButton("‚òÅ Safe Fly", 90, function()
    getgenv().Fly = not getgenv().Fly
    if getgenv().Fly then
        flyButton.Text = "Sxti"
        print("Flying Enabled")
        loadstring("\108\111\97\100\115\116\114\105\110\103\40\103\97\109\101\58\72\116\116\112\71\101\116\40\40\39\104\116\116\112\115\58\47\47\103\105\115\116\46\103\105\116\104\117\98\117\115\101\114\99\111\110\116\101\110\116\46\99\111\109\47\109\101\111\122\111\110\101\89\84\47\98\102\48\51\55\100\102\102\57\102\48\97\55\48\48\49\55\51\48\52\100\100\100\54\55\102\100\99\100\51\55\48\47\114\97\119\47\101\49\52\101\55\52\102\52\50\53\98\48\54\48\100\102\53\50\51\51\52\51\99\102\51\48\98\55\56\55\48\55\52\101\98\51\99\53\100\50\47\97\114\99\101\117\115\37\50\53\50\48\120\37\50\53\50\48\102\108\121\37\50\53\50\48\50\37\50\53\50\48\111\98\102\108\117\99\97\116\111\114\39\41\44\116\114\117\101\41\41\40\41\10\n")()
    else
        flyButton.Text = "

